<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>ECharts</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="css/sweetalert2.min.css">
    <style type="text/css">
        * {
        box-sizing: border-box; -webkit-tap-highlight-color: rgba(0,0,0,0); -webkit-text-size-adjust:none;
        -webkit-overflow-scrolling: touch;
        }
        html, h1, h2, h3, h4, p { margin:0; padding:0; font-weight: normal; }
        ul, ol { margin:0; list-style: none; padding: 0; }
        a { text-decoration:none; color: black; border:none; outline: none; }
        img { border:none; }
        input, button { -webkit-appearance: none; background: none; padding: 0; outline-style: none; border: none; }
        form, table { margin:0; padding:0; }
        em, i { font-style: normal; }

        #controls {
            position: absolute;
            z-index: 2;
            right: 10%;
            top: 5%;
            background-color: darkgrey;
            padding: 10px;
        }
        #controls .icon {
            margin: 0 5px;
        }
        #controls .icon img { width: 20px; vertical-align: sub; }
        #controls .info { 
            margin-top: 10px;
            text-align: center; 
        }
    </style>
</head>

<body>
    <div id="hover-console"></div>
    <div id="controls">
        <a id="add" class="icon" href="#"><img src="images/add.png"/> 添加部门</a>
        <a id="delete" class="icon" href="#"><img src="images/delete.png"/> 删除部门</a>
        <div class="info" id="info">董事长 权利最大的人</div>
    </div>

    <div id="main" style="height:100vh"></div>
    <script src="zepto.min.js"></script>
    <script src="sweetalert2.min.js"></script>
    
    <script src="echarts.js"></script>
    <script src="TreeGraph.js"></script>
    <script type="text/javascript">
        var itemStyle = {};
            itemStyle.normal = {};
            itemStyle.normal.borderWidth = 2;
            itemStyle.normal.borderColor = "red"; 
        var itemSelected = {};
        var myChart;
        var zNodes=[
            {id:1,pId:0,name:"董事长"},
            {id:11,pId:1,name:"经理"},
            {id:12,pId:1,name:"副总"},
            {id:13,pId:1,name:"秘书"},
            {id:16,pId:11,name:"财务经理"},
            {id:27,pId:11,name:"人事经理"},
            {id:18,pId:12,name:"HR"},
        ];
        $(function () {
            $("#add").click(function(e){
                e.preventDefault();
                
                swal({
                    title: '添加部门',
                    input: 'text',
                    showCloseButton: true,
                    confirmButtonText: '确定'
                }).then(function (value) {
                    if(value) {
                        var tempData = {};
                        tempData.pId = itemSelected.id;
                        tempData.id = itemSelected.id + 1;
                        tempData.name = value; 
                        zNodes.push(tempData);//TODO 提交到后台
                        var data=getData(zNodes)
                        setData(myChart,data);
                    }
                })
            })

            $("#delete").click(function(e){
                e.preventDefault();
                //TODO 提交到后台
                swal({
                  text: "确定删除该部门及下属部门？",
                  type: 'warning',
                  showCancelButton: true,
                  confirmButtonColor: '#3085d6',
                  cancelButtonColor: '#d33',
                  confirmButtonText: '删除',
                  cancelButtonText: '取消'
                }).then(function () {
                    for (var i = 0; i < zNodes.length; i++) {
                        if(zNodes[i].id == itemSelected.id) {
                            zNodes.splice(i,1);
                        }
                    }
                    var data=getData(zNodes)
                    setData(myChart,data);
                })
                
            })
        })
        // 路径配置
        require.config({
            paths: {
                echarts: 'http://localhost/echart'
            }
        });
        // 使用
        require(
            [
                'echarts',
                'echarts/chart/tree'
            ],
            function (ec) {
                // 基于准备好的dom，初始化echarts图表
                myChart = ec.init(document.getElementById('main'));
                var data=getData(zNodes)
                itemSelected = data[0];
                itemSelected.itemStyle = itemStyle;

                setData(myChart,data);
                
                myChart.on('click', function(param) {
                    var temp = JSON.parse(JSON.stringify(zNodes));
                    //console.log(param);

                    for (var i = 0; i < temp.length; i++) {
                        if(temp[i].name == param.name) {
                            $("#info").text(temp[i].name);
                            temp[i].itemStyle = itemStyle;
                            break;
                        }
                    }
                    itemSelected = param.data;
                    var data=getData(temp);
                    //console.log("data:"+JSON.stringify(data));
                    setData(myChart,data,0);
                });
            }
        );
    </script>
</body>